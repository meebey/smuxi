#!/usr/bin/env bash

# workaround TLS/SSL negotiation caching issues of Mono, see:
# https://smuxi.im/issues/show/802
MONO_TLS_SESSION_CACHE_TIMEOUT=0
export MONO_TLS_SESSION_CACHE_TIMEOUT

# Mono >= 4 SEGVs with Boehm as GC during startup
# see https://bugzilla.opensuse.org/show_bug.cgi?id=955080
if ! mono -V | grep -q -e "version [4-9]\."; then
    # HACK: forcibly disabled SGen, as it has a known SEGV bug related to the
    # Mono.Data.Sqlite binding that does not happen with the boehm GC, see:
    # https://smuxi.im/issues/show/1062
    MONO_ENV_OPTIONS="$(echo $MONO_ENV_OPTIONS | sed s/--gc=sgen//)"
    MONO_ENV_OPTIONS="--gc=boehm $MONO_ENV_OPTIONS"
    export MONO_ENV_OPTIONS
fi

# needed for getting mono to work inside snap's sandbox
if [[ $SNAP ]]; then
    PKG_DIR=$SNAP/usr
    export MONO_PATH=$PKG_DIR/lib/mono/4.5:$PKG_DIR/lib/cli/log4net-1.2:$PKG_DIR/lib/cli/Nini-1.1:$PKG_DIR/lib/cli/gtk-sharp-2.0:$PKG_DIR/lib/cli/glib-sharp-2.0:$PKG_DIR/lib/cli/atk-sharp-2.0:$PKG_DIR/lib/cli/gdk-sharp-2.0:$PKG_DIR/lib/cli/pango-sharp-2.0:$MONO_PATH
    export MONO_CONFIG=$SNAP/etc/mono/config
    export MONO_CFG_DIR=$SNAP/etc
    export MONO_REGISTRY_PATH=~/.mono/registry
    export MONO_GAC_PREFIX=$PKG_DIR/lib/mono/gac/
fi

# Smuxi uses an IPC channel for the single application instance feature and it
# also allows to pass links from commandline to an existing Smuxi instance. This
# IPC channel must be private to the user that executes Smuxi, else other system
# users could control the existing Smuxi instance. Mono doesn't support LOCAL\
# named pipes yet and thus we need to emulate the privateness to the user by
# using a TMP directory that is only readable by the same user who started
# Smuxi. This also workarounds the world-writable unix socket in /tmp issue of
# Mono, see: https://smuxi.im/issues/show/1072
SMUXI_TMP=$HOME/.cache/smuxi/tmp
if [ ! -d $SMUXI_TMP ]; then
    mkdir -p $SMUXI_TMP
fi
chmod 700 $SMUXI_TMP
TMP=$SMUXI_TMP
export TMP

EXE_FILENAME=smuxi-frontend-gnome.exe
UNIX_NAME=smuxi

if [[ $SNAP ]]; then
    DIR_OF_THIS_SCRIPT=$(dirname "$(realpath "$0")")
    FRONTEND_PATH="$DIR_OF_THIS_SCRIPT/../lib/$UNIX_NAME/$EXE_FILENAME"
    exec mono "$FRONTEND_PATH" "$@"
fi

exec mono "@expanded_libdir@/@PACKAGE@/$EXE_FILENAME" "$@"
